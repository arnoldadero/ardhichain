<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Page</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Sofia&effect=neon|outline|emboss|shadow-multiple">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <header>
        <h1 class="font-effect-shadow-multiple">ARDHICHAIN</h1>
    </header>
    <div class="container">
        <div class="search-bar">
            <input type="text"  id="searchInput" placeholder="Enter title deed number..">
            <button onclick="search()"><i class="fa fa-search"></i></button>
        </div>
        <div class="results" id="results">
            <!-- Results will be displayed here -->
        </div>
        <div class="verification" id="verification" style="display:none;">
            <input type="text" id="nationalIdInput" placeholder="Enter your National ID...">
            <button onclick="verifyNationalId()">Verify</button>
        </div>
    </div>
    <footer>
        <p>&copy; 2024 ArdhiChain. All rights reserved.</p>
    </footer>

    <script>
        async function search() {
            const query = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('results');
            const verificationDiv = document.getElementById('verification');
            
            if (!query) {
                resultsDiv.innerHTML = 'Please enter a search term.';
                return;
            }
            
            resultsDiv.innerHTML = 'Searching...';
            
            if (verificationDiv) {
                verificationDiv.style.display = 'none';
            }
            
            try {
                const response = await fetch(`http://localhost:8080/search?id=${query}`);
                const text = await response.text();  // Get response as text
                console.log('Response Text:', text);  // Log the response text
                
                if (response.ok) {
                    try {
                        const block = JSON.parse(text);  // Attempt to parse JSON
                        if (block) {
                            displayResults(block);
                        } else {
                            resultsDiv.innerHTML = 'No results found.';
                        }
                    } catch (e) {
                        console.error('Error parsing JSON:', e);
                        resultsDiv.innerHTML = 'Error parsing server response.';
                    }
                } else {
                    console.error('Server returned an error:', response.status, response.statusText);
                    resultsDiv.innerHTML = `Error: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                console.error('Error fetching the data:', error);
                resultsDiv.innerHTML = 'An error occurred while fetching the results.';
            }
        }

        function displayResults(block) {
            const resultsDiv = document.getElementById('results');
            
            const blockHTML = `
                <div class="block">
                    <p><strong>Block ID:</strong> ${block.id}</p>
                    <p><strong>Previous Hash:</strong> ${block.previousHash}</p>
                    <p><strong>Hash:</strong> ${block.hash}</p>
                    <p><strong>Data:</strong> ${block.data}</p>
                    <p><strong>Timestamp:</strong> ${block.timestamp}</p>
                    <p><strong>Nonce:</strong> ${block.nonce}</p>
                    <button onclick="showVerification()">Verify National ID</button>
                </div>
            `;
            
            resultsDiv.innerHTML = blockHTML;
        }

        function showVerification() {
            const verificationDiv = document.getElementById('verification');
            if (verificationDiv) {
                verificationDiv.style.display = 'block';
            }
        }

        async function verifyNationalId() {
            const nationalId = document.getElementById('nationalIdInput').value;
            
            if (!nationalId) {
                alert('Please enter your National ID.');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:8080/verify`, {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nationalId })
                });
                
                if (!response.ok) {
                    console.error('Server returned an error:', response.status, response.statusText);
                    alert(`Error: ${response.status} ${response.statusText}`);
                    return;
                }
                
                const text = await response.text();  // Get response as text
                console.log('Response Text:', text);  // Log the response text
                
                try {
                    const result = JSON.parse(text);  // Attempt to parse JSON
                    if (result.verified) {
                        window.location.href = '/new-owner';
                    } else {
                        alert('National ID verification failed.');
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    alert('Error parsing server response.');
                }
            } catch (error) {
                console.error('Error verifying the national ID:', error);
                alert('An error occurred while verifying the national ID.');
            }
        }
        //         const response = await axios.post(`http://localhost:8080/verify`, {
        //             nationalId: nationalId
        //         });

        //         if (response.data.verified) {
        //             window.location.href = '/new-owner';
        //         } else {
        //             alert('National ID verification failed.');
        //         }
        //     } catch (error) {
        //         console.error('Error verifying the national ID:', error);
        //         alert('An error occurred while verifying the national ID.');
        //     }
        // }
    </script>
</body>
</html>
